<template>
	<view class="left-tool" :style="{ backgroundColor: color.bgPage }">
		<status-placeholder></status-placeholder>
		<view
			class="top"
			:style="{
				'box-shadow': isNightMode ? 'none' : '0px 7px 10px -3px rgba(158, 158, 158, 0.1)'
			}"
			@click="() => {}"
		>
			<view class="top-top">
				<view class="img"><image class="img" mode="aspectFill" :src="book.img" /></view>
				<view class="info">
					<view>
						<text class="title" :style="{ color: color.normalText }">{{ book.title }}</text>
						<!-- <u-icon size="30" name="arrow-right"></u-icon> -->
					</view>
					<view>
						<text class="info-text" :style="{ color: color.secText }">{{ book.author }}</text>
					</view>
					<view>
						<text class="info-text" :style="{ color: color.secText }">
							{{ '更新至 ' + (chapterList[chapterList.length - 1] ? chapterList[chapterList.length - 1].title : '') }}
						</text>
					</view>
					<view>
						<text class="info-text" :style="{ color: color.secText }">当前阅读进度{{ book.readPos }}%</text>
					</view>
				</view>
			</view>
			<view class="menu-block">
				<view class="tabs">
					<view class="tabs-main">
						<view class="tab"><text class="tab-text" :style="{ color: '#007aff' }">目录</text></view>
					</view>
					<view class="dot"></view>
				</view>
				<view class="menu-func">
					<image mode="aspectFill" class="menu-func-icon" src="/static/read/to-center.png" @click="toChapterPos" />
					<image mode="aspectFill" class="menu-func-icon" :src="toTopBottom" @click="toTopOrBottom" />
					<image mode="aspectFill" class="menu-func-icon" :src="oderIcon" @click="reverseChapterList" />999
				</view>
			</view>
		</view>
		<list class="bottom" :style="{ height: toolHeight + 'px', backgroundColor: color.cardBg, opacity: chapterLoaded ? '1' : '0' }">
			<cell style="height: 10px;"></cell>
			<cell ref="top"></cell>
			<cell v-for="(item, index) in chapterList" :key="index">
				<view
					:ref="index == readIndex ? 'chapterT' : 'chapter' + index"
					:id="'chapter' + index"
					@tap="changeChapter(index, item)"
					:class="{
						group: item.type == 'group',
						chapter: item.type == 'chapter'
					}"
				>
					<text class="text-style" :style="`color:${index == readIndex ? '#007aff' : color.normalText}`">{{ item.title }}</text>
				</view>
			</cell>
			<cell ref="bottom"></cell>
		</list>
	</view>
</template>
<script>
import statusPlaceholder from '@/components/status-placeholder.vue';
import { request } from '@/untils/http.js';
const dom = uni.requireNativePlugin('dom');
export default {
	components: { statusPlaceholder },
	data() {
		return {
			funcList: [{ name: '目录' }, { name: '书签' }],
			currentFunc: 0,
			toolHeight: 0,
			scrollView: '',
			chapterList: [],
			book: {},
			chapterLoaded: false,
			chaperListRe: false,
			isTop: true
		};
	},
	computed: {
		color() {
			return this.$store.getters.getColor;
		},
		isNightMode() {
			return this.$store.getters.getIsNightMode;
		},
		oderIcon() {
			return this.chaperListRe ? '/static/read/order-re.png' : '/static/read/order.png';
		},
		toTopBottom() {
			return this.isTop ? '/static/read/to-top.png' : '/static/read/to-bottom.png';
		},
		readIndex() {
			if (this.chaperListRe) {
				return this.chapterList.length - 1 - this.book.readIndex;
			} else {
				return this.book.readIndex;
			}
		}
	},
	mounted() {
		const systemInfo = getApp().globalData.systemInfo;
		this.toolHeight = systemInfo.windowHeight - systemInfo.statusBarHeight - 170;
		uni.$on('lt-chapter-list', data => {
			this.chapterList = data.chapterList;
			this.book = data.book;
		});
		uni.$on('leftToolTopen', data => {
			this.chapterLoaded = false;
			this.toChapterPos();
		});
	},
	destroyed() {
		uni.$off('lt-chapter-list');
		uni.$off('leftToolTopen');
	},
	methods: {
		toTopOrBottom() {
			let chapter = this.$refs.top;
			if (this.isTop) {
				chapter = this.$refs.bottom;
			}
			this.isTop=!this.isTop
			setTimeout(() => {
				dom.scrollToElement(chapter, {
					animated: false
				});
				this.chapterLoaded = true;
			}, 50);
		},
		toChapterPos() {
			const chapterT = this.$refs.chapterT;
			setTimeout(() => {
				dom.scrollToElement(chapterT[0], {
					animated: false
				});
				this.chapterLoaded = true;
			}, 50);
		},
		reverseChapterList() {
			this.chaperListRe = !this.chaperListRe;
			// this.chapterLoaded = false;
			this.chapterList = this.chapterList.reverse();
			this.toChapterPos();
		},
		goToNowChapter() {
			uni.screen;
		},
		changeFunc(index) {
			this.currentFunc = index;
		},
		initTool() {
			this.scrollView = 'chapter' + this.book.readIndex;
		},
		changeChapter(index, item) {
			if (item.type == 'chapter') {
				uni.$emit('changeChapter', index);
			}
		}
	}
};
</script>

<style lang="scss">
.left-tool {
	overflow: hidden;
	.top {
		height: 170px;
		width: 563rpx;
		padding-left: 30rpx;
		padding-right: 30rpx;
		padding-top: 30rpx;
		position: relative;
		z-index: 3;
		.menu-block {
			display: flex;
			flex-direction: row;
			align-items: center;
			position: relative;
			height: 55px;
			width: 502.5rpx;
			.menu-func {
				display: flex;
				flex-direction: row;
				align-items: center;
				position: absolute;
				height: 55px;
				right: 0;
				top: 6px;
				z-index: 5;
				.menu-func-icon {
					width: 22px;
					height: 22px;
					padding: 2px;
					margin-left: 6rpx;
				}
			}
			.tabs {
				width: 502.5rpx;
				position: absolute;
				height: 55px;
				top: 10rpx;
				left: 0;
				z-index: 5;
				display: flex;
				flex-direction: column;
				justify-content: center;
				.tabs-main {
					display: flex;
					flex-direction: row;
					align-items: center;
					justify-content: space-around;
					.tab {
						display: flex;
						flex-direction: row;
						align-items: center;
						.tab-text {
							font-size: 14px;
						}
					}
				}
				.dot {
					width: 35rpx;
					height: 5rpx;
					background-color: #007aff;
					border-radius: 3rpx;
					transform: translateX(233rpx);
					margin-top: 5px;
				}
			}
		}
		.top-top {
			display: flex;
			flex-direction: row;
			height: 100px;
			.img {
				width: 75px;
				height: 100px;
				border-radius: 7px;
				overflow: hidden;
			}
			.info {
				height: 100px;
				margin-left: 10px;
				color: #959595;
				display: flex;
				flex-direction: column;
				justify-content: space-between;
				.info-text {
					font-size: 12px;
				}
				.title {
					font-size: 18px;
					color: #000000;
				}
			}
		}
	}
	.bottom {
		background-color: #f9f9f9;
		width: 563rpx;
		position: relative;
		z-index: 2;
		opacity: 0;
		transition-property: opacity;
		transition-duration: 300ms;
		.group,
		.chapter {
			width: 563rpx;
			padding: 10px;
			overflow: hidden;
			.text-style {
				font-size: 14px;
			}
		}
		.group {
			font-size: 16px;
			// border-bottom: 1px solid #67bdff;
		}
	}
}
</style>
